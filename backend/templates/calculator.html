{% extends "base.html" %}

{% block content %}
<style> 
    .select2-container--default .select2-selection--single {
        height: 50px !important;
        display: flex !important;
        align-items: center !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 0.5rem !important;
        position: relative !important;
        padding-left: 10px !important;
    }
 
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 48px !important;
        position: absolute !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        right: 10px !important;  
        left: auto !important;  
        width: 20px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
 
    .select2-container--default .select2-selection--single .select2-selection__arrow b {
        transform: scale(0.7) !important;  
        margin: 0 !important;
        position: static !important;
    }
 
    .select2-selection__rendered {
        line-height: 50px !important;
        padding-left: 5px !important;
        padding-right: 30px !important;  
        color: #6c757d !important;
        text-align: left !important;
    }
 
    .card-body.d-flex.flex-column {
        height: 100%;
        justify-content: center !important;
    }
</style>
<div class="text-center mb-5 animate-fade-in">
    <h1 class="display-5 fw-bold">Disease Probability Calculator</h1>
    <p class="lead text-muted">Leveraging Bayes' Theorem for accurate diagnostic insights.</p>
</div>

<div class="row g-4 justify-content-center">
    <div class="col-lg-6 col-md-12">
        <div class="card h-100 shadow-sm card-hover">
            <div class="card-body p-4">
                <h2 class="card-title h4 text-center mb-4">Use Pre-Loaded Hospital Data</h2>
                <p class="text-center text-muted mb-4 small">The implementation of pre-loaded historical data enables clinicians to instantly retrieve a patient‚Äôs longitudinal medical history, such as prior surgical reports and baseline diagnostic tests, directly within the current EHR interface. By accessing these legacy records, medical staff can identify critical contraindications‚Äîlike documented drug allergies or chronic comorbidities‚Äîeven when the patient is unable to provide a history. This seamless integration eliminates the need for manual record requests, reduces redundant testing, and ensures that emergency interventions are informed by years of clinical context rather than just current symptoms.</p>

                
                <div class="dropdown-wrapper mb-5">
                    <label for="diseaseSelect" class="form-label fw-bold">Select Disease :</label>
                    <select id="diseaseSelect" class="form-select"
                        data-placeholder="Select disease from Hospital Data...">
                        <option value="" disabled selected></option>
                        {% for disease in diseases %}
                        <option value="{{ disease }}">{{ disease }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="d-grid mt-4 text-center">
                    <button type="button" class="btn btn-outline-primary btn-lg py-3" onclick="usePreset()"
                        id="loadSampleBtn">
                        <i class="fas fa-file-import me-2"></i>Load Sample Data
                    </button>
                    <!-- Pre-loaded Dataset Info -->
                    <div class="preloaded-info">
                    <h4>Available Sample Data</h4>

                    <div class="preloaded-scroll">
                        <ul>
                        <li>Migraine ‚Äì Prior: 0.01</li>
                        <li>Influenza ‚Äì Prior: 0.03</li>
                        <li>Diabetes ‚Äì Prior: 0.12</li>
                        <li>Hypertension ‚Äì Prior: 0.18</li>
                        <li>Heart Disease ‚Äì Prior: 0.07</li>
                        <li>Asthma ‚Äì Prior: 0.05</li>
                        </ul>
                    </div>
                    </div>

                    <small class="text-muted mt-3">Adjust details below, then click Check</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6 col-md-12">
        <div class="card h-100 shadow-sm card-hover">
            <div class="card-body p-4">
                <h2 class="card-title h4 text-center mb-4">Enter Custom Disease Data</h2>
                <p class="text-center text-muted mb-4 small">Adjust sliders or enter values directly. Click Check to calculate.</p>

                <div class="mb-3">
                    <label for="pDSlider" class="form-label d-flex justify-content-between">
                        <span><strong>Prior Probability of Disease - P(D)</strong></span>
                        <span class="badge bg-primary" id="pDValue">0.01</span>
                    </label>
                    <input type="range" class="form-range interactive-slider" id="pDSlider" min="0" max="1" step="0.01"
                        value="0.01">
                    <input type="number" id="pD" class="form-control form-control-lg mt-2" step="0.01" min="0" max="1" value="0.01">
                </div>

                <div class="mb-3">
                    <label for="sensitivitySlider" class="form-label d-flex justify-content-between">
                        <span><strong>Test Sensitivity - P(Pos | D)</strong></span>
                        <span class="badge bg-success" id="sensitivityValue">0.99</span>
                    </label>
                    <input type="range" class="form-range interactive-slider" id="sensitivitySlider" min="0" max="1"
                        step="0.01" value="0.99">
                    <input type="number" id="sensitivity" class="form-control form-control-lg mt-2" step="0.01" min="0"
                        max="1" value="0.99">
                </div>

                <div class="mb-3">
                    <label for="falsePositiveSlider" class="form-label d-flex justify-content-between">
                        <span><strong>False Positive Rate - P(Pos | No D)</strong></span>
                        <span class="badge bg-warning" id="falsePositiveValue">0.05</span>
                    </label>
                    <input type="range" class="form-range interactive-slider" id="falsePositiveSlider" min="0" max="1"
                        step="0.01" value="0.05">
                    <input type="number" id="falsePositive" class="form-control form-control-lg mt-2" step="0.01"
                        min="0" max="1" value="0.05">
                </div>

                <div class="mb-3">
                    <label for="testResult" class="form-label"><strong>Test Result</strong></label>
                    <select id="testResult" class="form-select form-select-lg">
                        <option value="positive" selected>Positive</option>
                        <option value="negative">Negative</option>
                    </select>
                </div>

                <div class="mt-4 p-3 rounded result-container hidden" id="interactiveResult" aria-live="polite">
                    <div class="row align-items-center">
                        <div class="col-12 mb-2">
                            <h6 class="mb-1">Prior Probability: <span id="priorValueDisplay" class="fw-bold">0.00</span></h6>
                            <h6 class="mb-2">Posterior Probability: <span id="posteriorValue" class="fw-bold">0.00</span></h6>
                        </div>
                        <div class="col-12 mb-2">
                            <div class="progress" style="height: 30px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                    id="posteriorProgressBar" role="progressbar" style="width: 0%">
                                    <span id="posteriorPercentage">0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 text-center">
                            <div id="riskLevelBadge" class="badge fs-6 p-2">
                                <span id="riskLevelText">Low Risk</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid mt-4 gap-2">
                <!-- Check Result Button -->
                    <button
                        type="button"
                        class="btn btn-success btn-lg shadow-sm py-3 fw-bold"
                        id="checkButton"
                        onclick="handleCheck()">
                        <span id="buttonText">
                            <i class="fas fa-check-circle me-2"></i>Check Result
                        </span>
                    </button>

                    <!-- Reset Button -->
                    <button
                        type="button"
                        class="btn btn-outline-danger"
                        onclick="resetCalculator()">
                        <i class="fas fa-rotate-left me-1"></i>Reset
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="result" class="alert alert-success fs-4 mt-5 p-4 text-center shadow-lg" role="alert" aria-live="assertive"></div>

<div id="chartContainer" class="card shadow-lg mt-4 result-container hidden" aria-live="polite">
    <div class="card-body p-4">
        <h3 class="card-title text-center mb-3">Probability Comparison</h3>
        <div class="chart-wrapper" style="height: 300px;">
            <canvas id="probabilityChartCanvas"></canvas>
        </div>
    </div>
</div>

<div id="recommendationsContainer" class="card shadow-lg mt-4" style="display: none;">
    <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-start mb-3 flex-wrap">
            <h3 class="card-title mb-0">
                <i class="fas fa-robot me-2"></i>AI-Powered Recommendations
            </h3>
            <div class="d-flex gap-2 align-items-center">
                <select id="languageSelect" class="form-select form-select-sm" style="width: auto; min-width: 150px;" onchange="changeRecommendationLanguage()">
                    <option value="english" selected>üá¨üáß English</option>
                    <option value="hindi">üáÆüá≥ ‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                    <option value="gujarati">üáÆüá≥ ‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä (Gujarati)</option>
                    <option value="tamil">üáÆüá≥ ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                </select>
                <button class="btn btn-sm btn-outline-primary" id="getRecommendationsBtn"
                    onclick="getAIRecommendations()">
                    <i class="fas fa-download me-1"></i>Get Recommendations
                </button>
            </div>
        </div>
        <div id="recommendationsLoading" class="text-center py-4" style="display: none;">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Generating AI recommendations...</p>
        </div>
        <div id="recommendationsContent" class="recommendations-text" style="display: none;"></div>
        <div class="alert alert-info mt-3 mb-0" id="recommendationsDisclaimer" style="display: none;">
            <small><strong>Note:</strong> These recommendations are educational. Consult healthcare professionals for medical advice.</small>
        </div>
    </div>
</div>

<div id="downloadSection" class="card shadow-lg mt-4" style="display: none;">
    <div class="card-body p-4">
        <h3 class="card-title text-center mb-3">Download Results</h3>
        <div class="d-flex gap-2 justify-content-center flex-wrap">
            <button class="btn btn-outline-success" onclick="downloadResults('pdf')">
                <i class="fas fa-file-pdf me-1"></i>Download as PDF
            </button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/css/select2.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/js/select2.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    $(document).ready(function () {
        $(document).on('select2:open', function () {
            let searchField = document.querySelector('.select2-container--open .select2-search__field');
            if (searchField) {
                searchField.focus();
            }
        });
    });
</script>
<script src="{{ url_for('static', filename='script.js') }}"></script>

{% endblock %}